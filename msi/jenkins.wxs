<?xml version="1.0"?>

<!--
  This file gets processed twice. Once by shell on the release machine, then
  once more by WiX toolkit on Windows build box.
  
  WiX variables are supposed to look like <DOLLAR>(var.VARNAME), which means
  it has to be written like <BACKSLASH><DOLLAR>(var.VARNAME) to survive the first processing
-->
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Name='$(var.ProductName) $(var.ProductVersion)' Id='*' UpgradeCode='$(var.ProductCode)'
    Language='1033' Codepage='1252' Version='$(var.EncodedVersion)' Manufacturer='$(var.ProductVendor)'>

    <Package Id='*' Platform="x64" Keywords='Installer' Description="$(var.ProductName)"
      Comments='$(var.ProductSummary)' InstallScope="perMachine"
      InstallerVersion='200' Compressed='yes' SummaryCodepage='1252' />
      <Media Id='1' Cabinet='$(var.ArtifactName).cab' EmbedCab='yes'/>
      
      <Icon Id="jenkins.ico" SourceFile="jenkins.ico" />
      
      <Directory Id='TARGETDIR' Name='SourceDir'>
        <Directory Id='ProgramFiles64Folder' Name='PFiles'>
          <Directory Id='JENKINSDIR' Name='$(var.ArtifactName)' FileSource=".">
            <Component Id='Main' Guid='e4a652bf-c210-4a45-95c4-5dc875b4880b' Win64='yes'>
              <File Name="jenkins.exe" Source='tmp/jenkins.exe' KeyPath='yes' Id="JenkinsExe"/>
              <fire:FirewallException Id="FwEx" Program="[JAVA_HOME]\bin\java.exe" Port="[PORTNUMBER]" Name="Jenkins" Scope="any" IgnoreFailure="yes" />
              <File Id="JenkinsXml" Name="jenkins.xml" Source='tmp/jenkins.xml' DiskId='1' />
              <File Name="jenkins.exe.config" Source='jenkins.exe.config' DiskId='1' />
              <File Name="$(var.ArtifactName).war" Source='$(var.WAR)' DiskId='1' />
              
              
              <!-- Update the XML file with the values selected during install -->
              <util:XmlFile Id='JenkinsXmlJenkinsData' Action='setValue' ElementPath='//service/env/@value' File='[#JenkinsXml]' Value='[JENKINS_ROOT].jenkins' Sequence="1"/>
              <util:XmlFile Id='JenkinsXmlExecutable' Action='setValue' ElementPath='//service/executable' File='[#JenkinsXml]' Value='[JAVA_HOME]\bin\java.exe' Sequence="1"/>
              <util:XmlFile Id='JenkinsXmlArguments' Action='setValue' ElementPath='//service/arguments' File='[#JenkinsXml]' Value='-Xrs -Xmx256m -Dhudson.lifecycle=hudson.lifecycle.WindowsServiceLifecycle [JAVA_11_JAVA_ARGS] -jar &quot;[JENKINSDIR]jenkins.war&quot; --httpPort=[PORTNUMBER] --webroot=&quot;[JENKINS_ROOT]war&quot; [JAVA_11_JENKINS_ARGS]' Sequence="1"/>
                <util:XmlFile Id='JenkinsXmlExtensionsPidfile' Action='setValue' ElementPath='//service/extensions/extension/pidfile' File='[#JenkinsXml]' Value='[JENKINS_ROOT]jenkins.pid' Sequence='1'/>
              <ServiceInstall Id="$(var.ArtifactName)Service"
                    Name="$(var.ArtifactName)"
                    DisplayName="$(var.ProductName)"
                    Type="ownProcess"
                    Start="auto"
                    ErrorControl="normal"
                    Description="$(var.ProductSummary)"
                    Account="[SERVICE_USERNAME]"
                    Password="[SERVICE_PASSWORD]" />
                <ServiceControl Id="Control$(var.ArtifactName)Service" Name="$(var.ArtifactName)" Start="install" Stop="both" Wait="yes" Remove="uninstall"/>
              </Component>
              
              <Component Id="Java11Deps" Guid='' Win64='yes'>
                <Condition><![CDATA[JAVA_EXE_VERSION = "11"]]></Condition>
                <!-- Java 11 requirements -->
                <File Name="jaxb-api-2.3.0.jar" Source='tmp/jaxb-api-2.3.0.jar' DiskId='1' />
                <File Name="jaxb-core-2.3.0.1.jar" Source='tmp/jaxb-core-2.3.0.1.jar' DiskId='1' />
                <File Name="jaxb-impl-2.3.0.1.jar" Source='tmp/jaxb-impl-2.3.0.1.jar' DiskId='1' />
                <File Name="javax.activation.jar" Source='tmp/javax.activation-1.2.0.jar' DiskId='1' />
              </Component>
            </Directory>
        </Directory>
      </Directory>

    <Upgrade Id="$(var.ProductCode)">
      <UpgradeVersion Minimum="0.0.0" Maximum="$(var.EncodedVersion)" Property="PREVIOUSVERSIONINSTALLED" />
    </Upgrade>
    
    <!-- Find a Java 8 installation (by default) -->
    <Property Id="JAVA_HOME">
      <RegistrySearch Id="JRE_HOME_REGSEARCH" Root="HKLM" Key="SOFTWARE\JavaSoft\Java Runtime Environment\1.8" Name="JavaHome" Type="raw" Win64="yes"/>
    </Property>
    
    <!-- Default Port Number -->
    <Property Id="PORTNUMBER" Value="8080" />
    <Property Id="ARPPRODUCTICON" Value="jenkins.ico" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />      <!-- Remove repair -->
    <Property Id="ARPNOMODIFY" Value="yes" Secure="yes" />      <!-- Remove modify -->
    <Property Id="JENKINS_ROOT" Value="%LocalAppData%\Jenkins\" />

    <CustomAction Id="BackupJenkinsXmlFile" Script="vbscript">
      <![CDATA[
        On Error Resume Next
        Err.Clear
        jenkinsDirPath = session.Property("JENKINSDIR")
        Set fsObj = CreateObject("Scripting.FileSystemObject")
        If fsObj.FolderExists(jenkinsDirPath) Then
            srcPath = jenkinsDirPath & "jenkins.xml"
            If fsObj.FileExists(srcPath) Then
                dstPath = jenkinsDirPath & "jenkins.xml.backup"
                If fsObj.FileExists(dstPath) Then
                    suffix = 1
                    While fsObj.FileExists(dstPath & "_" & suffix)
                        suffix = suffix + 1
                    Wend
                    dstPath = dstPath & "_" & suffix
                End If
                fsObj.CopyFile srcPath, dstPath, True
                Err.Clear
                On Error Goto 0
            End If
        End If
        Set fsObj = Nothing
      ]]>
    </CustomAction>
    
    <CustomAction Id="ValidateJavaHome" Script="vbscript">
      <![CDATA[
      On Error Resume Next
      Err.Clear
      javaHome = Session.Property("JAVA_HOME")
      Session.Property("JAVA_EXE_FOUND") = "0"
      Session.Property("JAVA_EXE_VERSION") = ""
      Set fsObj = CreateObject("Scripting.FileSystemObject")
      If fsObj.FolderExists(javaHome) Then
        javaExe = javaHome & "\bin\java.exe"
        If fsObj.FileExists(javaExe) Then
          Session.Property("JAVA_EXE_FOUND") = "1"
          javaExeVersion = fsObj.GetFileVersion(javaExe)
          Session.Property("JAVA_EXE_VERSION") = Left(javaExeVersion, InStr(javaExeVersion, ".") - 1)
        End If
      End If
      Set fsObj = Nothing
      ]]>
    </CustomAction>

    <InstallExecuteSequence>
      <!--
        Earlier I suffered a problem where after an upgrade, all the JRE files are removed
        (if I then repair the installation, it'll work, so it's not the missing definitions in the msi file.)

        I'm still new to MSI/WiX to be able to really understand what's going on, but
        http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg32537.html seems to explain the problem,
        (as caused by the interaction between deferred removal), and the take away from this thread
        as a whole seems to be that for auto-generated wxs files (from heat), it's just not possible
        to get the file updates done right (WTF?!).

        The InstallInitialize seems to work. My naive hypothesis is that this stops the service and
        deletes all the files before new ones are added (OTOH, I still get a dialog that some files
        are in use and I need to reboot, so I could be all wrong, or maybe the installer is showing
        this dialog incorrectly as a precaution, as alluded in http://www.mail-archive.com/wix-users@lists.sourceforge.net/msg06878.html)

        I remember seeing another e-mail on the wix-users list about <ServiceControl> not actually
        waiting until the full termination of the service, and if so, this still might not work.

        In any case, noting my experiments so that future changes to this value will be done very carefully.
      -->
      <Custom Action="BackupJenkinsXmlFile" After='InstallInitialize' />
      <RemoveExistingProducts After="BackupJenkinsXmlFile"/>
    </InstallExecuteSequence>

    <Feature Id='Complete' Level='1'>
      <ComponentRef Id='Main' />
      <ComponentRef Id='Java11Deps' />
    </Feature>
    
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="jenkins.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />

    <UI>
      <UIRef Id="WixUI_Common" />
      
      <Property Id="WixUI_Mode" Value="InstallDir" />
      
      <Dialog Id="JavaHomeDlg" Width="370" Height="270" Title="!(loc.JavaHomeDlgTitle)">
          <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)">
            <Publish Event="DoAction" Value="ValidateJavaHome" Order="1">1</Publish>
            
            <!-- Spawn the error dialog if java.exe can't be found. -->
            <Publish Property="ERROR_TITLE" Value="!(loc.JavaHomeDlgErrorTitle)" Order="2"><![CDATA[JAVA_EXE_FOUND = "0" OR JAVA_EXE_VERSION = "10" OR JAVA_EXE_VERSION = "9"]]></Publish>
            <Publish Property="ERROR_MESSAGE" Value="!(loc.JavaJomeDlgErrorMessage)" Order="3"><![CDATA[JAVA_EXE_FOUND = "0" OR JAVA_EXE_VERSION = "10" OR JAVA_EXE_VERSION = "9"]]></Publish>
            <Publish Event="SpawnDialog" Value="GenericErrorDlg" Order="4"><![CDATA[JAVA_EXE_FOUND = "0" OR JAVA_EXE_VERSION = "10" OR JAVA_EXE_VERSION = "9"]]></Publish>
            <Publish Property="JAVA_HOME" Value="[JAVA_HOME]">1</Publish>
            <Publish Property="JAVA_11_JAVA_ARGS" Value="-p jaxb-api-2.3.0.jar:javax.activation-1.2.0.jar --add-modules java.xml.bind,java.activation -cp jaxb-core-2.3.0.1.jar:jaxb-impl-2.3.0.1.jar"><![CDATA[JAVA_EXE_VERSION = "11"]]></Publish>
            <Publish Property="JAVA_11_JENKINS_ARGS" Value="--enable-future-java"><![CDATA[JAVA_EXE_VERSION = "11"]]></Publish>
          </Control>
          <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
          <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
            <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
          </Control>
          <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.JavaHomeDlgDescription)" />
          <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.JavaHomeDlgTitle)" />
          <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="WixUI_Bmp_Banner" />
          <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
          <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
          <Control Id="FolderLabel" Type="Text" X="20" Y="60" Width="290" Height="30" NoPrefix="yes" Text="!(loc.JavaHomeDlgLabel)" />
          <Control Id="Folder" Type="PathEdit" X="20" Y="100" Width="320" Height="18" Property="JAVA_HOME" />
          <Control Id="ChangeFolder" Type="PushButton" X="20" Y="120" Width="56" Height="17" Text="!(loc.JavaHomeDlgChange)">
            <Publish Property="_BrowseProperty" Value="JAVA_HOME" Order="1">1</Publish>
            <Publish Event="SpawnDialog" Value="JavaBrowseDlg" Order="2">1</Publish>
          </Control>
      </Dialog>
      
      <Dialog Id="JavaBrowseDlg" Width="370" Height="270" Title="[ProductName] Setup">
        <Control Id="PathEdit" Type="PathEdit" X="25" Y="202" Width="320" Height="18" Property="_BrowseProperty" Indirect="yes" />
        <Control Id="OK" Type="PushButton" X="240" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUIOK)">
            <Publish Event="EndDialog" Value="Return">1</Publish>
        </Control>
        <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
            <Publish Event="Reset" Value="0">1</Publish>
            <Publish Event="EndDialog" Value="Return">1</Publish>
        </Control>
        <Control Id="ComboLabel" Type="Text" X="25" Y="58" Width="44" Height="10" TabSkip="no" Text="!(loc.BrowseDlgComboLabel)" />
        <Control Id="DirectoryCombo" Type="DirectoryCombo" X="70" Y="55" Width="247" Height="80" Property="_BrowseProperty" Indirect="yes" Fixed="yes" Remote="yes">
            <Subscribe Event="IgnoreChange" Attribute="IgnoreChange" />
        </Control>
        <Control Id="WixUI_Bmp_Up" Type="PushButton" X="325" Y="55" Width="19" Height="19" ToolTip="!(loc.BrowseDlgWixUI_Bmp_UpTooltip)" Icon="yes" FixedSize="yes" IconSize="16" Text="!(loc.BrowseDlgWixUI_Bmp_Up)">
            <Publish Event="DirectoryListUp" Value="0">1</Publish>
        </Control>
        <Control Id="DirectoryList" Type="DirectoryList" X="25" Y="83" Width="320" Height="98" Property="_BrowseProperty" Sunken="yes" Indirect="yes" TabSkip="no" />
        <Control Id="PathLabel" Type="Text" X="25" Y="190" Width="320" Height="10" TabSkip="no" Text="!(loc.BrowseDlgPathLabel)" />
        <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.BrowseDlgBannerBitmap)" />
        <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
        <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />
        <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.JavaBrowseDlgDescription)" />
        <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.JavaBrowseDlgTitle)" />
      </Dialog>

      <DialogRef Id="BrowseDlg" />
      <DialogRef Id="DiskCostDlg" />
      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <DialogRef Id="PrepareDlg" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="ResumeDlg" />
      <DialogRef Id="UserExit" />
      <DialogRef Id="ServiceCredDlg"/>
      <DialogRef Id="ServicePortDlg"/>

      <Publish Dialog="BrowseDlg" Control="OK" Event="DoAction" Value="WixUIValidatePath" Order="3">1</Publish>
      <Publish Dialog="BrowseDlg" Control="OK" Event="SpawnDialog" Value="InvalidDirDlg" Order="4"><![CDATA[WIXUI_INSTALLDIR_VALID<>"1"]]></Publish>

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>

      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">1</Publish>

      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SetTargetPath" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="DoAction" Value="WixUIValidatePath" Order="2">NOT WIXUI_DONTVALIDATEPATH</Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="SpawnDialog" Value="InvalidDirDlg" Order="3"><![CDATA[NOT WIXUI_DONTVALIDATEPATH AND WIXUI_INSTALLDIR_VALID<>"1"]]></Publish>
      <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ServiceCredDlg" Order="4">WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID="1"</Publish>
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Property="_BrowseProperty" Value="[WIXUI_INSTALLDIR]" Order="1">1</Publish>
      <Publish Dialog="InstallDirDlg" Control="ChangeFolder" Event="SpawnDialog" Value="BrowseDlg" Order="2">1</Publish>
      
      <Publish Dialog="ServiceCredDlg" Control="Next" Event="NewDialog" Value="ServicePortDlg" Order="1">NOT Installed</Publish>
      <Publish Dialog="ServiceCredDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" Order="1">NOT Installed</Publish>
      
      <Publish Dialog="ServicePortDlg" Control="Next" Event="NewDialog" Value="JavaHomeDlg" Order="1">NOT Installed</Publish>
      <Publish Dialog="ServicePortDlg" Control="Back" Event="NewDialog" Value="ServiceCredDlg" Order="1">NOT Installed</Publish>
      
      <Publish Dialog="JavaHomeDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" Order="1">NOT Installed</Publish>
      <Publish Dialog="JavaHomeDlg" Control="Back" Event="NewDialog" Value="ServicePortDlg" Order="1">NOT Installed</Publish>

      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="JavaHomeDlg" Order="1">NOT Installed</Publish>
      <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="MaintenanceTypeDlg" Order="2">Installed</Publish>

      <Publish Dialog="MaintenanceWelcomeDlg" Control="Next" Event="NewDialog" Value="MaintenanceTypeDlg">1</Publish>

      <Publish Dialog="MaintenanceTypeDlg" Control="RepairButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="RemoveButton" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>
      <Publish Dialog="MaintenanceTypeDlg" Control="Back" Event="NewDialog" Value="MaintenanceWelcomeDlg">1</Publish>

      <Publish Dialog="ExitDialog" Control="Finish" Event="DoAction" Value="LaunchApplication">NOT installed</Publish>
    </UI>


    <!-- launch a browser at the end of the installation -->
    <SetProperty Id="WixShellExecTarget" Before="CostFinalize" Value="http://localhost:[PORTNUMBER]/"/>
    <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <Property Id="WIXUI_INSTALLDIR" Value="JENKINSDIR" />
    
    <!-- Set JAVA_HOME to the Program Files directory if it is empty so the JavaHomeDlg doesn't have an issue -->
    <SetProperty Id="JAVA_HOME" Before="CostFinalize" Value="[ProgramFiles64Folder]"><![CDATA[JAVA_HOME = ""]]></SetProperty>
  </Product>
</Wix>

